<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Project Darkwater - Home</title>
  <!-- CSRF disabled in security config -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
      pointer-events: none;
      z-index: 1;
    }

    /* Header/Navigation */
    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding: 20px 0;
      position: relative;
      z-index: 100;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: white;
      text-decoration: none;
    }

    .nav-links {
      display: flex;
      gap: 30px;
      list-style: none;
    }

    .nav-links a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      position: relative;
      z-index: 2;
      padding: 40px 20px;
    }

    .content-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Welcome Section */
    .welcome-section {
      text-align: center;
      margin-bottom: 50px;
    }

    .welcome-title {
      font-size: 48px;
      font-weight: 700;
      color: white;
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .welcome-subtitle {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 30px;
    }

    /* Admin News Management Section */
    .admin-news-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 40px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .admin-news-section.show {
      display: block;
    }

    .admin-tabs {
      display: flex;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 30px;
    }

    .admin-tab {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .admin-tab.active {
      background: #667eea;
      color: white;
    }

    .admin-tab-content {
      display: none;
    }

    .admin-tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd8;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .posts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .post-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .post-card:hover {
      transform: translateY(-5px);
    }

    .post-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }

    .post-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .post-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-news { background: #e3f2fd; color: #1976d2; }
    .badge-patch { background: #f3e5f5; color: #7b1fa2; }
    .badge-draft { background: #fff3e0; color: #f57c00; }
    .badge-scheduled { background: #e8f5e8; color: #388e3c; }
    .badge-published { background: #e1f5fe; color: #0277bd; }

    .post-excerpt {
      color: #666;
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 15px;
    }

    .post-actions {
      display: flex;
      gap: 6px;
    }

    .post-actions .btn {
      padding: 6px 12px;
      font-size: 12px;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* News Carousel Section */
    .news-carousel-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 40px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 32px;
      font-weight: 600;
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }

    .carousel-container {
      position: relative;
      overflow: hidden;
      border-radius: 15px;
    }

    .carousel-slide {
      min-width: 100%;
      position: relative;
      background: #f8f8f8;
      border-radius: 15px;
      overflow: hidden;
      height: 300px;
      display: none;
    }

    .carousel-slide.active {
      display: block;
    }

    .slide-content {
      padding: 40px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .slide-title {
      font-size: 28px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .slide-excerpt {
      font-size: 16px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .slide-date {
      font-size: 14px;
      color: #888;
      font-weight: 500;
    }

    .carousel-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .carousel-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ddd;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .carousel-dot.active {
      background: #667eea;
      transform: scale(1.2);
    }

    /* Split Section - Patch Notes & Play Button */
    .split-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .patch-notes-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .patch-title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .patch-version {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .patch-content {
      color: #666;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .patch-date {
      font-size: 14px;
      color: #888;
      font-weight: 500;
    }

    .play-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .play-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 50px;
      border-radius: 50px;
      text-decoration: none;
      font-size: 24px;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .play-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .play-description {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
    }

    /* About Section */
    .about-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 50px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin-bottom: 40px;
    }

    .about-title {
      font-size: 36px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }

    .about-description {
      font-size: 18px;
      color: #666;
      line-height: 1.8;
      margin-bottom: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .about-button {
      background: transparent;
      color: #667eea;
      padding: 16px 40px;
      border: 2px solid #667eea;
      border-radius: 12px;
      text-decoration: none;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .about-button:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    /* Placeholder for non-functional carousel */
    .carousel-placeholder {
      text-align: center;
      padding: 60px;
      color: #666;
      font-style: italic;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .welcome-title {
        font-size: 36px;
      }

      .split-section {
        grid-template-columns: 1fr;
      }

      .news-carousel-section,
      .patch-notes-panel,
      .play-panel,
      .about-section {
        padding: 30px 25px;
      }

      .nav-links {
        display: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .posts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<!-- Header -->
<div class="header">
  <div class="nav-container">
    <a href="/home" class="logo">Project Darkwater</a>

    <ul class="nav-links">
      <li><a href="/profile">Profile</a></li>
      <li><a href="/content">Content</a></li>
      <li><a href="/api-docs">API Docs</a></li>
      <li th:if="${isAdmin}"><a href="/admin">Admin</a></li>
      <li th:if="${isAdmin || isSupportStaff || isModerator}">
        <a href="/staff">Staff Panel</a>
      </li>
      <li th:unless="${isAdmin || isSupportStaff || isModerator}">
        <a href="/apply">Apply</a>
      </li>
      <li><a href="/logout">Logout</a></li>
    </ul>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <div class="content-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
      <h1 class="welcome-title">Welcome, <span th:text="${username}"></span>!</h1>
      <p class="welcome-subtitle">Dive into the depths of adventure and discovery</p>
      <!-- Admin News Management Toggle -->
      <div th:if="${isAdmin}">
        <button onclick="toggleNewsManagement()" class="btn btn-primary" style="margin-top: 20px;">
          📰 Manage News & Patch Notes
        </button>
      </div>
    </div>

    <!-- Admin News Management Section (Only visible to admins) -->
    <section th:if="${isAdmin}" class="admin-news-section" id="newsManagement">
      <h2 class="section-title">News & Patch Notes Management</h2>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="showAdminTab('create')">Create New Post</button>
        <button class="admin-tab" onclick="showAdminTab('drafts')">Drafts</button>
        <button class="admin-tab" onclick="showAdminTab('published')">Published</button>
      </div>

      <!-- Create New Post Tab -->
      <div id="create-tab" class="admin-tab-content active">
        <form id="post-form">
          <div class="form-group">
            <label class="form-label">Post Type</label>
            <select class="form-select" id="type" required>
              <option value="">Select type...</option>
              <option value="NEWS">News Article</option>
              <option value="PATCH_NOTES">Patch Notes</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" id="title" required>
          </div>

          <div class="form-group">
            <label class="form-label">Excerpt (for carousel)</label>
            <textarea class="form-textarea" id="excerpt" placeholder="Short summary for carousel display..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Content</label>
            <textarea class="form-textarea" id="content" required style="min-height: 200px;"></textarea>
          </div>

          <div class="form-row" id="patch-fields" style="display: none;">
            <div class="form-group">
              <label class="form-label">Version Number</label>
              <input type="text" class="form-input" id="versionNumber" placeholder="e.g., 1.2.3">
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="majorRelease">
                <label class="form-label">Major Release</label>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Featured Image URL</label>
              <input type="url" class="form-input" id="featuredImage">
            </div>
            <div class="form-group">
              <label class="form-label">Tags (comma-separated)</label>
              <input type="text" class="form-input" id="tags" placeholder="release, major, bugfix">
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save as Draft</button>
            <button type="button" class="btn btn-success" onclick="publishNow()">Publish Now</button>
          </div>
        </form>
      </div>

      <!-- Drafts Tab -->
      <div id="drafts-tab" class="admin-tab-content">
        <h3>Draft Posts</h3>
        <div class="posts-grid" id="drafts-grid">
          <!-- Draft posts will be loaded here -->
        </div>
      </div>

      <!-- Published Tab -->
      <div id="published-tab" class="admin-tab-content">
        <h3>Published Posts</h3>
        <div class="posts-grid" id="published-grid">
          <!-- Published posts will be loaded here -->
        </div>
      </div>
    </section>

    <!-- News Carousel Section -->
    <section class="news-carousel-section">
      <h2 class="section-title">Latest News</h2>
      <div class="carousel-container">
        <!-- Show real news if available -->
        <div th:if="${carouselNews != null and !carouselNews.isEmpty()}" class="carousel-track" id="carouselTrack">
          <div th:each="news, iterStat : ${carouselNews}"
               th:class="${iterStat.index == 0} ? 'carousel-slide active' : 'carousel-slide'">
            <div class="slide-content">
              <h3 class="slide-title" th:text="${news.title}">News Title</h3>
              <p class="slide-excerpt" th:text="${news.excerpt ?: #strings.substring(news.content, 0, 150) + '...'}">News excerpt...</p>
              <span class="slide-date" th:text="${news.formattedPublishedDate ?: 'Coming Soon'}">Date</span>
            </div>
          </div>
        </div>

        <!-- Fallback placeholder if no news -->
        <div th:if="${carouselNews == null or carouselNews.isEmpty()}" class="carousel-placeholder">
          <p>Welcome to Project Darkwater's news center!</p>
          <p>Our PR team can create and publish news articles and patch notes.</p>
          <p>All posts are managed with complete anonymity - only date and time information is displayed.</p>
        </div>
      </div>

      <!-- Carousel navigation -->
      <div th:if="${carouselNews != null and carouselNews.size() > 1}" class="carousel-nav" id="carouselNav">
        <span th:each="news, iterStat : ${carouselNews}"
              th:class="${iterStat.index == 0} ? 'carousel-dot active' : 'carousel-dot'"
              th:onclick="'showSlide(' + ${iterStat.index} + ')'"></span>
      </div>
    </section>

    <!-- Split Section: Patch Notes & Play Button -->
    <div class="split-section">
      <!-- Patch Notes Panel -->
      <div class="patch-notes-panel">
        <h3 class="patch-title">Latest Patch Notes</h3>

        <!-- Show real patch notes if available -->
        <div th:if="${latestPatch != null}">
          <span class="patch-version" th:text="'v' + ${latestPatch.versionNumber}">v1.0.0</span>
          <div class="patch-content">
            <p th:text="${latestPatch.excerpt ?: #strings.substring(latestPatch.content, 0, 200) + '...'}">Patch content...</p>
          </div>
          <div class="patch-date" th:text="'Release Date: ' + ${latestPatch.formattedPublishedDate}">Release Date: Coming Soon</div>
        </div>

        <!-- Fallback placeholder if no patch notes -->
        <div th:if="${latestPatch == null}" class="patch-placeholder">
          <span class="patch-version">v1.0.0</span>
          <div class="patch-content">
            <p>Patch notes system is ready! Our PR team can create version-specific patch notes. All posts maintain complete anonymity with only date and time information.</p>
          </div>
          <div class="patch-date">Release Date: Coming Soon</div>
        </div>
      </div>

      <!-- Play Button Panel -->
      <div class="play-panel">
        <a href="#" class="play-button">Play Now</a>
        <p class="play-description">
          Jump into Project Darkwater and experience the latest updates and features.
          Your adventure awaits in the depths!
        </p>
      </div>
    </div>

    <!-- About Section -->
    <section class="about-section">
      <h2 class="about-title">Want to know more about Project Darkwater?</h2>
      <p class="about-description">
        Discover the depths of our underwater adventure game. Learn about our vision,
        the development team, and the immersive world we're creating for players worldwide.
      </p>
      <a href="/about" class="about-button">Read "About Us" here!</a>
    </section>
  </div>
</div>

<script>
  let currentSlide = 0;
  let editingPostId = null;

  // CSRF is disabled in SecurityConfig, so no token needed

  // Carousel functionality
  const slides = document.querySelectorAll('.carousel-slide');
  const dots = document.querySelectorAll('.carousel-dot');

  function showSlide(index) {
    if (slides.length === 0) return;

    slides.forEach(slide => slide.classList.remove('active'));
    dots.forEach(dot => dot.classList.remove('active'));

    if (slides[index]) {
      slides[index].classList.add('active');
      if (dots[index]) dots[index].classList.add('active');
    }

    currentSlide = index;
  }

  function nextSlide() {
    if (slides.length === 0) return;
    currentSlide = (currentSlide + 1) % slides.length;
    showSlide(currentSlide);
  }

  // News Management Functions
  function toggleNewsManagement() {
    const section = document.getElementById('newsManagement');
    section.classList.toggle('show');
    if (section.classList.contains('show')) {
      loadPosts('DRAFT');
    }
  }

  function showAdminTab(tabName) {
    document.querySelectorAll('.admin-tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.admin-tab').forEach(btn => {
      btn.classList.remove('active');
    });

    document.getElementById(tabName + '-tab').classList.add('active');

    // Find and activate the correct tab button
    const tabButtons = document.querySelectorAll('.admin-tab');
    tabButtons.forEach(btn => {
      if (btn.textContent.toLowerCase().includes(tabName)) {
        btn.classList.add('active');
      }
    });

    // Load posts after a small delay to ensure DOM is ready
    setTimeout(() => {
      if (tabName === 'drafts') loadPosts('DRAFT');
      if (tabName === 'published') loadPosts('PUBLISHED');
    }, 100);
  }

  // Show/hide patch-specific fields
  document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('type');
    if (typeSelect) {
      typeSelect.addEventListener('change', function() {
        const patchFields = document.getElementById('patch-fields');
        if (this.value === 'PATCH_NOTES') {
          patchFields.style.display = 'grid';
        } else {
          patchFields.style.display = 'none';
        }
      });
    }

    // Initialize carousel
    if (slides.length > 1) {
      setInterval(nextSlide, 5000);
    }
  });

  // Save as draft
  async function saveDraft() {
    const postData = getFormData();
    postData.status = 'DRAFT';
    await savePost(postData);
  }

  // Publish immediately
  async function publishNow() {
    const postData = getFormData();
    const response = await savePost(postData);

    if (response && response.id) {
      await fetch(`/api/news/${response.id}/publish`, {
        method: 'POST',
        credentials: 'same-origin'
      });
      showAlert('Post published successfully!', 'success');
      clearForm();
      // Refresh page to show new content
      setTimeout(() => window.location.reload(), 1000);
    }
  }

  // Get form data
  function getFormData() {
    return {
      title: document.getElementById('title').value,
      content: document.getElementById('content').value,
      excerpt: document.getElementById('excerpt').value,
      type: document.getElementById('type').value,
      versionNumber: document.getElementById('versionNumber').value,
      isMajorRelease: document.getElementById('majorRelease').checked,
      featuredImage: document.getElementById('featuredImage').value,
      tags: document.getElementById('tags').value
    };
  }

  // Save post - UPDATED to auto-show drafts
  async function savePost(postData) {
    try {
      const url = editingPostId ? `/api/news/${editingPostId}` : '/api/news';
      const method = editingPostId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(postData),
        credentials: 'same-origin'
      });

      if (response.ok) {
        const result = await response.json();
        showAlert('Post saved successfully!', 'success');
        clearForm();

        // Only auto-switch to drafts for draft saves
        if (postData.status === 'DRAFT') {
          setTimeout(() => {
            loadPosts('DRAFT');
            showAdminTab('drafts');
          }, 200);
        }

        return result;
      } else {
        const errorText = await response.text();
        console.error('Save error:', response.status, errorText);
        showAlert(`Error saving post: ${response.status} ${response.statusText}`, 'error');
      }
    } catch (error) {
      console.error('Save error:', error);
      showAlert('Error saving post: ' + error.message, 'error');
    }
  }

  // Load posts by status
  async function loadPosts(status) {
    try {
      const response = await fetch(`/api/news/admin/status/${status}?size=20`, {
        credentials: 'same-origin'
      });
      if (response.ok) {
        const data = await response.json();
        // Map status to correct container suffix
        const containerMap = {
          'DRAFT': 'drafts',
          'PUBLISHED': 'published'
        };
        displayPosts(data.content, containerMap[status]);
      } else {
        console.error('Load posts error:', response.status, response.statusText);
      }
    } catch (error) {
      console.error('Error loading posts:', error);
    }
  }

  // Display posts in grid
  function displayPosts(posts, containerSuffix) {
    const container = document.getElementById(containerSuffix + '-grid');

    // Check if container exists
    if (!container) {
      console.error('Container not found:', containerSuffix + '-grid');
      return;
    }

    container.innerHTML = '';

    if (posts.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No ' + containerSuffix + ' posts found.</p>';
      return;
    }

    posts.forEach(post => {
      const postCard = createPostCard(post);
      container.appendChild(postCard);
    });
  }

  // Create post card element
  function createPostCard(post) {
    const card = document.createElement('div');
    card.className = 'post-card';

    const badgeClass = post.type === 'NEWS' ? 'badge-news' : 'badge-patch';
    const statusBadge = `badge-${post.status.toLowerCase()}`;

    card.innerHTML = `
      <div class="post-title">${post.title}</div>
      <div class="post-meta">
        <span class="post-badge ${badgeClass}">${post.type}</span>
        <span class="post-badge ${statusBadge}">${post.status}</span>
        ${post.isMajorRelease ? '<span class="post-badge" style="background: #ffecb3; color: #f57f17;">MAJOR</span>' : ''}
      </div>
      <div class="post-excerpt">${post.excerpt || post.content.substring(0, 80) + '...'}</div>
      <div class="post-actions">
        <button class="btn btn-primary" onclick="editPost(${post.id})">Edit</button>
        ${post.status === 'DRAFT' ? `<button class="btn btn-success" onclick="publishPost(${post.id})">Publish</button>` : ''}
        <button class="btn btn-danger" onclick="deletePost(${post.id})">Delete</button>
      </div>
    `;

    return card;
  }

  // Edit post
  async function editPost(id) {
    try {
      const response = await fetch(`/api/news/${id}`, {
        credentials: 'same-origin'
      });
      const post = await response.json();

      document.getElementById('title').value = post.title;
      document.getElementById('content').value = post.content;
      document.getElementById('excerpt').value = post.excerpt || '';
      document.getElementById('type').value = post.type;
      document.getElementById('versionNumber').value = post.versionNumber || '';
      document.getElementById('majorRelease').checked = post.isMajorRelease;
      document.getElementById('featuredImage').value = post.featuredImage || '';
      document.getElementById('tags').value = post.tags || '';

      if (post.type === 'PATCH_NOTES') {
        document.getElementById('patch-fields').style.display = 'grid';
      }

      editingPostId = id;
      showAdminTab('create');

    } catch (error) {
      showAlert('Error loading post for editing: ' + error.message, 'error');
    }
  }

  // Publish post
  async function publishPost(id) {
    try {
      await fetch(`/api/news/${id}/publish`, {
        method: 'POST',
        credentials: 'same-origin'
      });
      showAlert('Post published successfully!', 'success');
      loadPosts('DRAFT');
      // Refresh page to show new content
      setTimeout(() => window.location.reload(), 1000);
    } catch (error) {
      showAlert('Error publishing post: ' + error.message, 'error');
    }
  }

  // Delete post
  async function deletePost(id) {
    if (!confirm('Are you sure you want to delete this post?')) return;

    try {
      await fetch(`/api/news/${id}`, {
        method: 'DELETE',
        credentials: 'same-origin'
      });
      showAlert('Post deleted successfully!', 'success');

      // Refresh current tab
      const activeTab = document.querySelector('.admin-tab.active');
      if (activeTab) {
        const tabText = activeTab.textContent.toLowerCase();
        if (tabText.includes('draft')) loadPosts('DRAFT');
        if (tabText.includes('published')) loadPosts('PUBLISHED');
      }
    } catch (error) {
      showAlert('Error deleting post: ' + error.message, 'error');
    }
  }

  // Clear form
  function clearForm() {
    document.getElementById('post-form').reset();
    document.getElementById('patch-fields').style.display = 'none';
    editingPostId = null;
  }

  // Show alert
  function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;

    const container = document.querySelector('.content-container');
    container.insertBefore(alertDiv, container.firstChild);

    setTimeout(() => alertDiv.remove(), 5000);
  }
</script>
</body>
</html>