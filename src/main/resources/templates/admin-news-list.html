<script>
    // Tab switching
    function switchTab(tabName) {
        // Remove active class from all tabs and buttons
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

        // Add active class to selected tab and button
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');

        // Load data for the selected tab
        loadTabData(tabName);
    }

    // Toggle version fields for patch notes
    function toggleVersionFields() {
        const postType = document.getElementById('post-type').value;
        const versionFields = document.getElementById('version-fields');
        versionFields.style.display = postType === 'PATCH_NOTES' ? 'block' : 'none';
    }

    // API helper function
    async function apiCall(url, method = 'GET', data = null) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };

        if (data) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Handle empty responses
            const text = await response.text();
            return text ? JSON.parse(text) : {};
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }

    // Load data for each tab
    async function loadTabData(tabName) {
        try {
            let url;
            switch(tabName) {
                case 'drafts':
                    url = '/api/news/admin/status/DRAFT';
                    break;
                case 'scheduled':
                    url = '/api/news/admin/status/SCHEDULED';
                    break;
                case 'published':
                    url = '/api/news/admin/status/PUBLISHED';
                    break;
                default:
                    return;
            }

            const data = await apiCall(url);
            displayPosts(data.content || data, tabName);
        } catch (error) {
            console.error('Error loading posts:', error);
            showError('Failed to load posts. Please try again.');
        }
    }

    // Display posts in the grid
    function displayPosts(posts, tabName) {
        const grid = document.getElementById(`${tabName}-grid`);

        if (!posts || posts.length === 0) {
            grid.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <h3>No ${tabName} posts</h3>
                <p>Create your first post to get started.</p>
            </div>
        `;
            return;
        }

        grid.innerHTML = posts.map(post => createPostCard(post)).join('');
    }

    // Create post card HTML
    function createPostCard(post) {
        return `
        <div class="post-card">
            <div class="post-header">
                <div>
                    <div class="post-title">${escapeHtml(post.title)}</div>
                    <div class="post-meta">
                        <span class="meta-item meta-type">${post.type}</span>
                        <span class="meta-item meta-status ${post.status.toLowerCase()}">${post.status}</span>
                        ${post.versionNumber ? `<span class="meta-item">v${post.versionNumber}</span>` : ''}
                        ${post.isMajorRelease ? `<span class="meta-item" style="background: #ff6b6b; color: white;">MAJOR</span>` : ''}
                    </div>
                </div>
            </div>
            ${post.excerpt ? `<div class="post-excerpt">${escapeHtml(post.excerpt)}</div>` : ''}
            <div class="post-footer">
                <small>Created: ${formatDate(post.createdAt)}</small>
                ${post.scheduledDate ? `<small>Scheduled: ${formatDate(post.scheduledDate)}</small>` : ''}
                ${post.publishedDate ? `<small>Published: ${formatDate(post.publishedDate)}</small>` : ''}
            </div>
            <div class="post-actions">
                <button class="btn btn-sm btn-secondary" onclick="editPost(${post.id})">Edit</button>
                ${generateActionButtons(post)}
                <button class="btn btn-sm btn-danger" onclick="deletePost(${post.id})">Delete</button>
            </div>
        </div>
    `;
    }

    // Generate action buttons based on post status
    function generateActionButtons(post) {
        if (post.status === 'DRAFT') {
            return `
            <button class="btn btn-sm btn-warning" onclick="showScheduleModal(${post.id})">Schedule</button>
            <button class="btn btn-sm btn-success" onclick="publishPost(${post.id})">Publish Now</button>
        `;
        } else if (post.status === 'SCHEDULED') {
            return `<button class="btn btn-sm btn-success" onclick="publishPost(${post.id})">Publish Now</button>`;
        }
        return '';
    }

    // Save draft
    async function saveDraft() {
        try {
            const postData = getFormData();
            await apiCall('/api/news', 'POST', postData);
            showSuccess('Draft saved successfully!');
            clearForm();
            loadTabData('drafts');
        } catch (error) {
            console.error('Error saving draft:', error);
            showError('Failed to save draft');
        }
    }

    // Schedule post
    async function schedulePost() {
        try {
            const postData = getFormData();
            const scheduleDate = document.getElementById('schedule-date').value;
            const scheduleTime = document.getElementById('schedule-time').value;

            if (!scheduleDate || !scheduleTime) {
                showError('Please select both date and time for scheduling');
                return;
            }

            const result = await apiCall('/api/news', 'POST', postData);
            const postId = result.id;

            // Now schedule it
            await apiCall(`/api/news/${postId}/schedule?scheduledDate=${scheduleDate}T${scheduleTime}`, 'POST');

            showSuccess('Post scheduled successfully!');
            clearForm();
            loadTabData('scheduled');
        } catch (error) {
            console.error('Error scheduling post:', error);
            showError('Failed to schedule post');
        }
    }

    // Publish now
    async function publishNow() {
        try {
            const postData = getFormData();
            const result = await apiCall('/api/news', 'POST', postData);
            const postId = result.id;

            // Now publish it
            await apiCall(`/api/news/${postId}/publish`, 'POST');

            showSuccess('Post published successfully!');
            clearForm();
            loadTabData('published');
        } catch (error) {
            console.error('Error publishing post:', error);
            showError('Failed to publish post');
        }
    }

    // Publish existing post
    async function publishPost(postId) {
        if (!confirm('Are you sure you want to publish this post?')) return;

        try {
            await apiCall(`/api/news/${postId}/publish`, 'POST');
            showSuccess('Post published successfully!');
            refreshAllTabs();
        } catch (error) {
            console.error('Error publishing post:', error);
            showError('Failed to publish post');
        }
    }

    // Show schedule modal for existing posts
    function showScheduleModal(postId) {
        const scheduledDate = prompt('Enter scheduled date and time (YYYY-MM-DD HH:MM):');
        if (!scheduledDate) return;

        scheduleExistingPost(postId, scheduledDate);
    }

    // Schedule existing post
    async function scheduleExistingPost(postId, scheduledDate) {
        try {
            await apiCall(`/api/news/${postId}/schedule?scheduledDate=${scheduledDate}`, 'POST');
            showSuccess('Post scheduled successfully!');
            refreshAllTabs();
        } catch (error) {
            console.error('Error scheduling post:', error);
            showError('Failed to schedule post');
        }
    }

    // Delete post
    async function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;

        try {
            await apiCall(`/api/news/${postId}`, 'DELETE');
            showSuccess('Post deleted successfully!');
            refreshAllTabs();
        } catch (error) {
            console.error('Error deleting post:', error);
            showError('Failed to delete post');
        }
    }

    // Edit post (placeholder)
    function editPost(postId) {
        showError('Edit functionality coming soon!');
    }

    // Get form data
    function getFormData() {
        return {
            title: document.getElementById('title').value,
            content: document.getElementById('content').value,
            excerpt: document.getElementById('excerpt').value,
            type: document.getElementById('post-type').value,
            versionNumber: document.getElementById('version-number').value || null,
            isMajorRelease: document.getElementById('major-release').checked,
            featuredImage: document.getElementById('featured-image').value || null,
            tags: document.getElementById('tags').value || null
        };
    }

    // Clear form
    function clearForm() {
        document.getElementById('create-form').reset();
        toggleVersionFields();
    }

    // Refresh all tabs
    function refreshAllTabs() {
        loadTabData('drafts');
        loadTabData('scheduled');
        loadTabData('published');
    }

    // Publish scheduled posts manually
    async function publishScheduled() {
        try {
            await apiCall('/api/news/admin/publish-scheduled', 'POST');
            showSuccess('Scheduled posts processed successfully!');
            refreshAllTabs();
        } catch (error) {
            console.error('Error publishing scheduled posts:', error);
            showError('Failed to process scheduled posts');
        }
    }

    // Utility functions
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    }

    function showSuccess(message) {
        showNotification(message, 'success');
    }

    function showError(message) {
        showNotification(message, 'error');
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        z-index: 10000;
        font-weight: 600;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadTabData('drafts');
    });
</script>